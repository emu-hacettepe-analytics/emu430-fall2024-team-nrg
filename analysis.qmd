---
title: "Analysis"
---

# Library Preparation

```{r}
#| echo: true
#| message: false
#| warning: false
library(dplyr)
library(ggplot2)
library(tidyr)
library(scales)
library(readr)
library(readxl)
library(ggthemes)
library(forcats)
```

```{r load-workspace}
#| include: false
load("emu430_project_workspace.RData")
```

# ANALAYSIS WITH CO2 EMISSION FROM TRANSPORT DATA (my_data3)

In this part of analysing, my_data3 will be using. Therefore, here is the general information that's needed:

```{r}
#| echo: true
str(my_data3)
```

**entity:** A character column in my_data3 data set which represents the countries, continents, some income levels and the world.

**code:** A character column in my_data3 data set which represents the codes of the countries. (There are no codes for noncountries)

**year:** An integer column in my_data3 data set which represents the year.

**transport_co2_emissions:** A numeric column in my_data3 data set which represents the total carbon emission in ton.

## Country Based Mean Transportation CO2 Emission
Final look at the top 20 countries' mean transportation carbondioxide emission from 2011 to 2021. To do this, entity column of my_data3 has tidied.

```{r}
#| echo: true
non_countries <- c(
  "World", 
  "Upper-middle-income countries", 
  "Lower-middle-income countries", 
  "Low-income countries", 
  "High-income countries", 
  "European Union (27)", 
  "Europe", 
  "Asia", 
  "Africa",
  "North America",
  "South America",
  "Oceania"
)

mean_co2_emission_by_country <- my_data3 |> 
  filter(!entity %in% non_countries) |>
  group_by(entity) |>
  summarize(mean_co2_emission_per_year = mean(transport_co2_emissions, na.rm = TRUE)) |>
  mutate(entity_lumped = fct_lump_n(entity, n = 20, w = mean_co2_emission_per_year)) |>
  group_by(entity_lumped) |>
  summarize(mean_co2_emission_per_year = mean(mean_co2_emission_per_year, na.rm = TRUE), .groups = "drop")

head(mean_co2_emission_by_country)
```

```{r}
#| echo: true
ggplot(mean_co2_emission_by_country, aes(x = reorder(entity_lumped, mean_co2_emission_per_year), y = mean_co2_emission_per_year, fill = entity_lumped)) +
  geom_col(width = 0.5) +
  scale_y_continuous(labels = label_number(scale = 1, accuracy = 1)) +
  coord_flip() +
  labs(x = "Country",
       y = "Mean CO2 Emission",
       title = "Mean CO2 Emission by Country",
       subtitle = "From 2011 to 2021 (in tons)") +
  theme_light() +
  theme(legend.position = "none")
```

The big majority of mean transportation carbondioxide emissions consisted of top 20 countries.

Scandinavia countries, such as Denmark and Norway, are really worth to analyze their transportation carbondioxide emissions and electric/non-electric EV sales, as they have not listed in the top 20 countries with the largest mean carbondioxide emission level.

Turkey is 19th country with the largest mean transportation carbondioxide emission level.

It's needed to see the transportation carbondioxide emission levels of countries through the years to get more information about them. Below, the amounts of some of those 20 countries' (which are chosen specifically by team NRG) transportation carbondioxide emission (in tons) are displayed in the graph with the tidied version of my_data3.

**emission_by_country:** This is the more tidied version of my_data3. 

```{r}
head(emission_by_country)
```

```{r}
#| echo: true
ggplot(emission_by_country, aes(x = year, y = transport_co2_emissions, color = entity)) +
  geom_line(size = 1) +
  scale_y_continuous(
    trans = "log10",
    breaks = c(1, 10, 100, 1000, 10000, 100000, 1000000, 10000000, 100000000, 1000000000, 10000000000),
    labels = c("1", "10", "100", "1K", "10K", "100K", "1M", "10M", "100M", "1B", "10B")
  ) +
  scale_x_continuous(breaks = 2011:2021) +
  facet_wrap(~ entity) +
  labs(x = "Year", 
       y = "CO2 Emission",
       title = "Carbondioxide Emissions by Entity (Logarithmic Scale)",
       subtitle = "From 2011 to 2021 (in tons)"
       ) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1)) # rotate x-axis labels
```
  Here are some observations from this graph:

1.  It can be observed that there is a persistent increase in the carbondioxide emission levels in Turkey and China. China is very close to emit one billion tons of carbondioxide.

2.  Denmark has decreased its carbondioxide emission level after a 10-year horizon. Japan and Norway has a considerable decreasing trend in its carbondioxide emission level.

3.  USA has the highest carbondioxide emission compared to others, exceeding one billion tons of carbondioxide.

  This graph compares those 6 countries very well, but it's not possible to see the trends for each of them. Therefore, the line plot below has been made to display the trend in the transportation carbondioxide emission levels of those exactly same countries to make a comparison.

```{r}
#| echo: true
top6_countries <- c("United States", "Norway", "Denmark", "China", "Japan", "Turkey")

emission_by_country <- my_data3 |>
  filter(entity %in% top6_countries)

head(emission_by_country)
```

```{r}
#| echo: true
ggplot(emission_by_country, aes(x = year, y = transport_co2_emissions, color = entity)) +
  geom_line(size = 1) +
  scale_y_continuous(
    trans = "log10",
    breaks = c(1, 10, 100, 1000, 10000, 100000, 1000000, 10000000, 100000000, 1000000000, 10000000000),
    labels = c("1", "10", "100", "1K", "10K", "100K", "1M", "10M", "100M", "1B", "10B")
  ) +
  scale_x_continuous(breaks = 2011:2021) +
  facet_wrap(~ entity, scale = "free_y") +
  labs(x = "Year", 
       y = "CO2 Emission",
       title = "Carbondioxide Emissions by Entity (Logarithmic Scale)",
       subtitle = "Carbondioxide emission trends from 2011 to 2021"
       ) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1)) # rotate x-axis labels
```

Here are some observations from this graph:

1.  It can be observed that China's, USA's and Turkey's total transportation carbondioxide emission level have an increasing trend over years while Denmark's, Norway's and Japan's have a decreasing trend.

2. All of the countries have a clear reduction of total transportation carbondioxide emission level in 2020. This is the effect of COVID-19 pandemic which causes a v-shaped pattern for all countries listed.

This graphs gives a lot information about transportation carbondioxide emission levels of those countries. But is it correct to make a decision from only these graphs? May population be the reason of some countries' low/high total transportation carbondioxide emission levels? Let's analyse it with the graph seen below.

BURAYA GELECEK TOLKAN YAPTIGIN GRAPH

Here are some observations from this graph:

1.  When we analyse the transportation carbon emission per person, even China has the one of the highest total transportation carbondioxide emission, it can be seen that China has the lowest transportation carbondioxide emission per person among all other countries. While USA on the other hand, still has the highest level.

2. Denmark's, Norway's and Japan's transportation carbon emission per person have a decreasing trend. 

3. Turkey's transportation carbon emission per person is not high but it has an increasing trend.

4. The decrease in 2020 can be seen again.

# Global EV Sales (my_data2)

```{r}
str(my_data2)
```
**region:** A character column in my_data2 data set which represents the countries and the world.

**category:** A character column in my_data2 data set which represents how the data has collected.

**parameter:**  A character column in my_data2 data set which represents the parameter of the data collected.

**mode:** A character column in my_data2 data set which represents the vehicle types.

**powertrain:** A character column in my_data2 data set which represents how the vehicle gets its power from, a.k.a. type of the powertrain that the vehicle uses which are EV, BEV, PHEV etc.

**year:** A numeric column in my_data2 data set which represents the year.

**unit:** A character column in my_data2 data set which represents the unit that is used.

**value:** A numeric column in my_data2 data set which represents the amount of the vehicles in unit.


##Sales of No Carbon Vehicles 

What about the countries' adoption on EV's? To be able to understand the relation between EV sales and transportation, my_data2 is used. The same countries are filtered from it.

The types of EV's are summarized below.

-   Battery Electric Vehicle (BEV)
-   Plug-in Hybrid Electric Vehicle (PHEV)
-   Fuel Cell Electric Vehicle (FCEV)
-   Hybrid Electric Vehicle (HEV)
-   Mild Hybrid Vehicle (MHEV)

BEV and FCEV sales are analysed since they're the no carbon ones.

```{r}
#| echo: true
my_data2$region[my_data2$region == "Turkiye"] <- "Turkey"
top6_countries = c("USA", "Norway", "Denmark", "China", "Japan", "Turkey")
no_carbon = c("BEV", "FCEV")

top6_ev_sales <- my_data2 |>
  filter(region %in% top6_countries, parameter == "EV sales", powertrain %in% no_carbon)

top6_ev_sales |> mutate(value = as.numeric(format(value, scientific = FALSE)))

head(top6_ev_sales)
```

```{r}
#| echo: true
top6_ev_sales |> group_by(year, region, powertrain) |>
  summarize(total_sales = sum(value, na.rm = TRUE), .groups = "drop") |>
  ggplot(aes(x = year, y = total_sales, color = region, linetype = powertrain)) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = 2011:2021) +
  scale_y_continuous(trans = "log10",
                     labels = label_number(scale = 1, accuracy = 1)
                     ) +
  labs(x = "Year",
       y = "Sales",
       title = "Sales of No Carbon Vehicles (Logarithmic Scale)",
       subtitle = "The behaviour of the number of sales of vehicles that emit no carbon over time",
       color = "Region",
       linetype = "Powertrain Type"
  ) +
  facet_wrap(~ region) +
  theme_light() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + # rotate x-axis labels
  guides(color = "none") # remove the region legend
  
top6_ev_sales
```

Here are some observations from this graph and the graphs before:

1. All countries in the plot increased their non-carbon emitting vehicle sales after 10-year horizon. However, Turkey has not been adopted FCEV's through 2021 while the other countries are using FCEV's more year by year. China has started using FCEV's (in 2016) later than the others (in 2011-2014). It can be also observed that BEV sales has started 2012 in Turkey.

2. China has increased its BEV and FCEV sales more than any other country, however from the last analyses we know that it couldn't make any big difference in total transportation carbondioxide emission since it's population is too high. On the other hand in Norway and Denmark, BEVs and FCEVs has a positive effect on total transportation carbondioxide emission since their populations are much lower than China.

3. It seems like Japan didn't increase the sales of BEVs and FCEVs, yet they managed to decrease the total transportation carbondioxide emission, which means they did some other applications.

# Turkey's Status (my_data4)

```{r}
#| echo: true
str(my_data4)
```

**year:** A character column in my_data4 data set which represents the year.

**total:** A character column in my_data4 data set which represents the total number of vehicles that are on traffic.

**percentage_total:** A character column which represents the total number of vehicles over total number of vehicles.

**gas:** A column in my_data4 data set which represents the vehicles which operates with gas.

**percentage_gas:** A character column which represents the number of vehicles that uses gas over total number of vehicles.

**diesel:** A column in my_data4 data set which represents the vehicles which operates with diesel.

**percentage_diesel:** A character column which represents the number of vehicles that are diesel over total number of vehicles.

**lpg:** A column in my_data4 data set which represents the vehicles which operates with LPG.

**percentage_lpg:** A character column which represents the number of vehicles that uses lpg over total number of vehicles.

**hybrid:** A column in my_data4 data set which represents the vehicles which operates with hybrid.

**percentage_hybrid:** A character column which represents the number of vehicles that are hybrid over total number of vehicles.

**electric:** A column in my_data4 data set which represents the vehicles which operates with electric.

**percentage_electric:** A character column which represents the number of vehicles that uses electric over total number of vehicles.

**unknown:** A column in my_data4 data set which represents the vehicles which operates with unknown power.

**percentage_unknown:** A character column which represents the number of vehicles that are unknown over total number of vehicles.

## Vehicle Trends

How about the adoption of EVs and the others in Turkey? In this part of analysing, my_data4 will be using.

```{r}
#| echo: true
tr_vehicle_num <- my_data4 |>
  mutate(across(everything(), as.numeric)) |>
  select(-starts_with("percentage"))

tr_vehicle_num_long <- tr_vehicle_num |>
  pivot_longer(
    cols = c(gas, diesel, lpg, hybrid, electric, unknown), 
    names_to = "vehicle_type", 
    values_to = "value"        
  )

head(tr_vehicle_num_long)
```

These are provided in the line plot below.

```{r}
#| echo: false
ggplot(tr_vehicle_num_long, aes(x = year, y = value, color = vehicle_type)) +
  geom_line(size = 1) +
  labs(x = "Year",
       y = "Value",
       title = "Vehicle Trends in Turkey Over Time (Logarithmic Scale)",
       subtitle = "From 2011 to 2021"
  ) +
  scale_x_continuous(breaks = 2011:2021) +
  scale_y_continuous(
    trans = "log10",
    breaks = c(1, 10, 100, 1000, 10000, 100000, 1000000, 10000000),
    labels = c("1", "10", "100", "1K", "10K", "100K", "1M", "10M")
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)
  )
```

Although there was an increase in EV's and hybrid vehicles, Turkey's total transportation carbondioxide emission has increased consistently (information from Country Based Mean Transportation CO2 Emission part) and the effect of COVID-19 pandemic was quite temporary on it.

The cumulative bar plot below displays the proportion of vehicle types over time.

```{r}
#| echo: true
vehicle_prop <- c("percentage_gas", "percentage_diesel", "percentage_lpg", "percentage_hybrid", "percentage_electric", "percentage_unknown")

tr_vehicle_perc_long <- my_data4 |>
  pivot_longer(cols = vehicle_prop, names_to = "vehicle_type", values_to = "percentage") |>
  select(year, vehicle_type, starts_with("percentage"))

tr_vehicle_perc_long$percentage <- as.numeric(tr_vehicle_perc_long$percentage)

head(tr_vehicle_perc_long)
```

```{r}
#| echo: true
ggplot(tr_vehicle_perc_long, aes(x = year, y = percentage, fill = vehicle_type)) +
  geom_bar(stat = "identity", position = "fill", width = 0.8) +
  scale_fill_brewer(palette = "Paired") +
  labs(x = "Year",
       y = "Percentage",
       title = "Vehicle Propensity in Turkey Over Time",
       subtitle = "From 2011 to 2021"
  ) +
  theme_tufte()
```

In fact, non-EV's were still used widely in Turkey, leading to increasing carbondioxide emission levels.

## Mean Transportation Emission

Turkey's average transportation carbondioxide emission per vehicle is displayed in the line plot below.

```{r}
#| echo: true
tr_emission <- my_data3 |>
  filter(entity == "Turkey")

tr_vehicle <- my_data4 |>
  select(year, total)

tr_vehicle$year <- as.numeric(tr_vehicle$year)

tr_emission_n_vehicle <- tr_emission |>
  left_join(tr_vehicle, by = c("year"))

tr_emission_n_vehicle$total <- as.numeric(tr_emission_n_vehicle$total)
tr_emission_n_vehicle$year <- as.numeric(tr_emission_n_vehicle$year)

head(tr_emission_n_vehicle)
```

```{r}
#| echo: true
tr_avg_emission <- tr_emission_n_vehicle |>
  mutate(avg_co2_emission_per_vehicle = transport_co2_emissions / total) |>
  ggplot(aes(x = year, y = avg_co2_emission_per_vehicle)) +
  geom_line(color = "blue", size = 1) +
  scale_x_continuous(breaks = 2011:2021) +
  geom_vline(xintercept = 2020, color = "black", size = 0.5, linetype = "dashed") +
  geom_text(x = 2020, y = 5.5, label = "pandemic", color = "black", vjust = -1) +
  labs(x = "Year",
       y = "Average CO2 Emission per Year",
       title = "Average CO2 Emission Per Vehicle in Turkey (in tons)",
       subtitle = "How much carbondioxide does a vehicle emit on the average?"
  ) +
  theme_minimal()

tr_avg_emission
```

# Income Based Mean Emission (An addition part, my_data3)

my_data3 has some columns which represents the countries according to their income levels. Therefore, here is the visualization of how the mean carbondioxide emissions has changed by countries' income level. (Buraya lineplot yapilacak degisiklikler olacak ve eklenen seylerin aciklamalari yazilacak.)

```{r}
#| echo: true
countries_by_income <- c(
  "Upper-middle-income countries", 
  "Lower-middle-income countries", 
  "Low-income countries", 
  "High-income countries"
)

total_co2_emission_by_income <- my_data3 |> 
  filter(entity %in% countries_by_income) |>
  rename(income_class = entity) |>
  group_by(income_class) |>
  summarize(total_co2_income = sum(transport_co2_emissions, na.rm = TRUE))

total_co2_emission_by_income
```

```{r}
#| echo: true
ggplot(total_co2_emission_by_income, aes(x = reorder(income_class, total_co2_income), y = total_co2_income, fill = income_class)) +
  geom_col() +
  scale_y_continuous(labels = label_number(scale = 1, accuracy = 1)) +
  coord_flip() +
  labs(x = "Income Class",
       y = "Total CO2 Emission",
       title = "Total CO2 Emission by Income Class",
       subtitle = "From 2011 to 2021 (in tons)") +
  theme_light() +
  theme(legend.position = "none")
```

As expected, the more income levels, the high emission levels that a country would have.
